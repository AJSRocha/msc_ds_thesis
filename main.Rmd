---
title: "Proposta para trabalho a desenvolver para tese de mestrado em Ciência de Dados"
author: "Alberto Rocha, 200202358"
date: '2022-09-21'
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning =F)
```

# Setup

```{r}
library(forecast)
#library(ggfortify); 
library(gridExtra); #library(ggplotify)
library(tidyverse)
library(wesanderson)
library(dplyr)

#atencao ao carregar o ggfortify e o ggplotify, eles sao incompativeis com os metodos de autoplot e autolayer

#library(CatDyn)
```

# Importar dados

## Vendas-Dia

Carregar vendas dia:

```{r, include = F}
# source('scripts/vd_import.R')
load('data/initial_data_occ.Rdata')
```

Função auxiliar que agrupa vd em regioes (S vs W) e cria as unidades temporais necessarias para as secçoes seguintes:

```{r, include = F}

seasonador = function(x){
  mod = ifelse(as.numeric(as.character(x$year_sale)) == as.numeric(as.character(x$fishing_season)),
               0,
               1)
  week_start =paste0(as.numeric(as.character(x$year_sale))-mod, '-10-01') %>% 
    as.POSIXct(format = '%Y-%m-%d')
    res = difftime(x$IDATVEND, week_start, units = 'weeks') %>% trunc() + 1
    return(res)
  }


arranjador = function(df){
  temp = df %>%
    mutate(regiao = case_when(as.character(zona) %in% 
                              c('27.9.a.c.n', '27.9.a.c.s') ~ 'Costa Ocidental',
                            as.character(zona) == '27.9.a.s.a' ~ 'Costa Sul',
                            T ~ as.character(zona)),
           dia = weekdays(IDATVEND),
           semana = lubridate::isoweek(IDATVEND),
           semana_tot = paste(year_sale, semana %>% formatC(width = 2,
                                                            format = 'd',
                                                            flag = '0')),
           fishing_season = case_when(month_sale %in% c('10','11','12') ~
                                        as.numeric(as.character(year_sale)),
                                      T ~ as.numeric(as.character(year_sale)) - 1) %>% factor)
  return(temp)
}
```

Executa transformação do dataframe

```{r}
df = arranjador(vd) %>% 
  mutate(semana_fs = seasonador(.))

df %>% select(year_sale, IDATVEND, semana, fishing_season, semana_fs) %>% View()
# grava df no data 
```

Compila vendas-dia em series temporais

```{r}
## Série de desembarques frota artesanal - Costa Sul:

ts_w_S = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(semana_tot, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Sul') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1995, end= 2023, frequency = 52)

ts_m_S = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(year_sale, month_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Sul') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1995, end= 2023, frequency = 12)

ts_q_S = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(year_sale, quarter_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Sul') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1995, end= 2023, frequency = 4)

ts_y_S = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(year_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Sul') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1995, end= 2023, frequency = 1)

ts_fs_S = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(fishing_season, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Sul') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1994, end= 2023, frequency = 1)


# grid.arrange(
# autoplot(ts_w_S) + theme_classic() + labs(title = 'Semanal'),
# autoplot(ts_m_S) + theme_classic() + labs(title = 'Mensal'),
# autoplot(ts_q_S) + theme_classic() + labs(title = 'Trimestral'),
# autoplot(ts_y_S) + theme_classic() + labs(title = 'Anual'),
# ncol = 2)


## Série de desembarques frota artesanal - Costa Ocidental:

ts_w_W = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(semana_tot, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Ocidental') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1995, end= 2023, frequency = 52)

ts_m_W = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(year_sale, month_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Ocidental') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1995, end= 2023, frequency = 12)

ts_q_W = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(year_sale, quarter_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Ocidental') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1995, end= 2023, frequency = 4)

ts_y_W = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(year_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Ocidental') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1995, end= 2023, frequency = 1)

ts_fs_W = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(fishing_season, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Ocidental') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1994, end= 2023, frequency = 1)


# grid.arrange(
# autoplot(ts_w_W) + theme_classic() + labs(title = 'Semanal'),
# autoplot(ts_m_W) + theme_classic() + labs(title = 'Mensal'),
# autoplot(ts_q_W) + theme_classic() + labs(title = 'Trimestral'),
# autoplot(ts_y_W) + theme_classic() + labs(title = 'Anual'),
# ncol = 2)
```

```{r}
ts_w__FS_S = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(semana, fishing_season, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Sul') %>% View
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1994, end= 2023, frequency = 53)

ts_w_FS_W = df %>%
  filter(regiao %in% c('Costa Ocidental', 'Costa Sul')) %>% 
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(semana, fishing_season, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Ocidental') %>%
  ungroup() %>% 
  select(QVENDA) %>% 
  ts(start = 1994, end= 2022, frequency = 52)
```


## Dados Biologicos

186 One important shortcoming of the data was that the biological sampling of mean weight 187 did not occur in all weeks of the 19 seasons and yet individual weight data are necessary 188 to transform from catch in weight to catch in numbers in all weeks (Supplementary Table 189 SM1). As in previous cases with missing biological sampling (Roa-Ureta, 2015; Roa-Ureta 190 et al., 2019, 2020) the missing mean individual weight was replaced with predictions from 191 an accessory model fit with the available data. First, we fitted a simple model of mean 192 weight change through the weeks of the year with a cubic spline smoother, function 193 loess in R 3.6.1 (R Core Team, 2019). Little inter-annual variability was observed in 194 the seasonal pattern of the mean individual weight (Fig. 2) and this pattern was similar 195 to results presented in Fern ́andez-Rueda and Garc ́ıa-Fl ́ orez (2007). Thus we used the 196 pooled data from all 19 seasons to estimate the weekly mean weight model (n=275). 197 In the fit of this accessory model we created a predictor variable spanning the range of 198 week numbers in a year (1 to 53), then we used the data to fit the smoother with a span 199 parameter equal to 1 (equivalent to using the data from all weeks to predict the model 200 at each week), and finally to predict the expected mean weight and its standard error for 201 all weeks within a season (Supplementary Fig. SM2). Secondly, we predicted the mean 202 weight for each week in each season from a truncated normal distribution defined by the 203 predicted weekly mean weight ± 2 standard errors using R package Runuran (Leydold 204 and H ̈ ormann, 2019) (Supplementary Fig. SM2). In this manner we obtained a complete 205 vector of mean weight matching the catch and effort data while introducing noise due to 206 sampling variation in the biological data.

## Outputs

Exporta os objectos de forma a serem usados na app shiny

```{r}
save(ts_m_S, ts_m_W,
     ts_fs_S, ts_fs_W,
     ts_y_S, ts_y_W,
     ts_q_S, ts_q_W,
     ts_w_S, ts_w_W,
     file = 'app/data/box_jenkins.Rdata')
```




# Indices de esforço

* Dias de Pesca Estandardizados

* Metodologia Pereira - Lourenço

* Numero de embarcações activas (Roa-Ureta)

# Modelos

## Metodologia de Box - Jenkins

## CMSY++

## JABBA

## SPiCT

## CatDyn

Modelo Ruben_Roa
data collection by each fishing season:
-	daily catch in weight
-	fishing effort measured as the number of boats operating on any single day.
-	biological samples to provide data of mean individual weight in the catch to transform catch in weight to catch in numbers. 
-	raw data were aggregated into weekly time-steps to fit intra-annual generalized depletion models to each season’s data. 











































