---
title: "R Notebook"
output: html_notebook
---


```{r}

```

# Methodology

```{r}
citation('stats')
citation('forecast')
citation('tseries')
```


package \textit{stats}
package \textit{forecast}

```{r}
a = Sys.time()
## Weekly

ts_w_MIS_W = df %>%
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(semana, year_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Ocidental') %>%
  ungroup() %>% 
  dplyr::select(QVENDA) %>% 
  ts(start = c(1995, 1), end= c(2022,52), frequency = 52)

ts_w_OTB_W = df %>%
  filter(EGRUPART %in% c('OTB')) %>% 
  group_by(semana, year_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Ocidental') %>%
  ungroup() %>% 
  dplyr::select(QVENDA) %>% 
  ts(start = c(1995, 1), end= c(2022,52), frequency = 52)


ts_w_MIS_S = df %>%
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(semana, year_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Sul') %>%
  ungroup() %>% 
  dplyr::select(QVENDA) %>% 
  ts(start = c(1995, 1), end= c(2022,52), frequency = 52)


ts_w_OTB_S = df %>%
  filter(EGRUPART %in% c('OTB')) %>% 
  group_by(semana, year_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Sul') %>%
  ungroup() %>% 
  dplyr::select(QVENDA) %>% 
  ts(start = c(1995, 1), end= c(2022,52), frequency = 52)



## Yearly

ts_y_MIS_W = df %>%
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(year_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Ocidental') %>%
  ungroup() %>% 
  dplyr::select(QVENDA) %>% 
  ts(start = c(1995), end= c(2022), frequency = 1)


ts_y_OTB_W = df %>%
  filter(EGRUPART %in% c('OTB')) %>% 
  group_by(year_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Ocidental') %>%
  ungroup() %>% 
  dplyr::select(QVENDA) %>% 
  ts(start = c(1995), end= c(2022), frequency = 1)

ts_y_MIS_S = df %>%
  filter(EGRUPART %in% c('MIS_MIS')) %>% 
  group_by(year_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Sul') %>%
  ungroup() %>% 
  dplyr::select(QVENDA) %>% 
  ts(start = c(1995), end= c(2022), frequency = 1)

ts_y_OTB_S = df %>%
  filter(EGRUPART %in% c('OTB')) %>% 
  group_by(year_sale, regiao) %>% 
  summarise(QVENDA = sum(QVENDA)) %>% 
  filter(regiao == 'Costa Sul') %>%
  ungroup() %>% 
  dplyr::select(QVENDA) %>% 
  ts(start = c(1995), end= c(2022), frequency = 1)



b = Sys.time()
time.boxjenkins.preproc = b-a
```

```{r}
fig = 
grid.arrange(
  
autoplot(ts_w_MIS_W, col = col_mis_w) + theme_classic() + 
  labs(title = 'Weekly Series - Polyvalent fleet - West Coast',
       x = 'Year',
       y = 'landings (kg)'),   
  
autoplot(ts_w_OTB_W, col = col_otb_w) + theme_classic() + 
  labs(title = 'Weekly Series - Bottom Trawl fleet - West Coast',
       x = 'Year',
       y = 'landings (kg)'),
  
autoplot(ts_w_MIS_S, col = col_mis_s) + theme_classic() + 
  labs(title = 'Weekly Series - Polyvalent fleet - South Coast',
       x = 'Year',
       y = 'landings (kg)'),

autoplot(ts_w_OTB_S, col = col_otb_s) + theme_classic() + 
  labs(title = 'Weekly Series - Bottom Trawl fleet - South Coast',
       x = 'Year',
       y = 'landings (kg)'),

ncol = 1)

ggsave(fig, dpi = 300, width = 20, height = 20, units = 'cm', filename = 'plots/res_boxjenkins_weekly_series.png')
```

```{r}
fig = 
grid.arrange(
  
autoplot(ts_y_MIS_W, col = col_mis_w) + theme_classic() + 
  labs(title = 'Yearly Series - Polyvalent fleet - West Coast',
       x = 'Year',
       y = 'landings (kg)'),

autoplot(ts_y_OTB_W, col = col_otb_w) + theme_classic() + 
  labs(title = 'Yearly Series - Bottom Trawl fleet - West Coast',
       x = 'Year',
       y = 'landings (kg)'),
  
autoplot(ts_y_MIS_S, col = col_mis_s) + theme_classic() + 
  labs(title = 'Yearly Series - Polyvalent fleet - South Coast',
       x = 'Year',
       y = 'landings (kg)'),
	   
autoplot(ts_y_OTB_S, col = col_otb_s) + theme_classic() + 
  labs(title = 'Yearly Series - Bottom Trawl fleet - South Coast',
       x = 'Year',
       y = 'landings (kg)'),

ncol = 1)

ggsave(fig, dpi = 300, width = 20, height = 20, units = 'cm', filename = 'plots/res_boxjenkins_yearly_series.png')
```


# ACF - Weekly West

```{r, fig.height = 20, fig.width=20}
dev.new()
par(mfrow = c(2,2), cex.main = 3)
acf(ts_w_MIS_W, col = col_mis_w, main = 'West MIS - Weekly - ACF', lwd = 5);
pacf(ts_w_MIS_W, col = col_mis_w, main = 'West MIS - Weekly - pACF', lwd = 5)
acf(ts_w_OTB_W, col = col_otb_w, main = 'West OTB - Weekly - ACF', lwd = 5);
pacf(ts_w_OTB_W, col = col_otb_w, main = 'West OTB - Weekly - pACF', lwd = 5)

grid.echo()
fig = grid.grab()
ggsave(fig, dpi = 300, units = 'cm', filename = 'plots/res_boxjenkins_week_W_acf.png')
```

# ACF - Weekly South

```{r, fig.height=20, fig.width=20}

par(mfrow = c(2,2), cex.main = 3)
acf(ts_w_MIS_S, col = col_mis_s, main = 'South MIS - Weekly - ACF', lwd = 5);
pacf(ts_w_MIS_S, col = col_mis_s, main = 'South MIS - Weekly - pACF', lwd = 5)
acf(ts_w_OTB_S, col = col_otb_s, main = 'South OTB - Weekly - ACF', lwd = 5);
pacf(ts_w_OTB_S, col = col_otb_s, main = 'South OTB - Weekly - pACF', lwd = 5)

grid.echo()
fig = grid.grab()

ggsave(fig, dpi = 300, units = 'cm', filename = 'plots/res_boxjenkins_week_S_acf.png')
```

# ACF - Yearly West

```{r, fig.height = 20, fig.width=20}
dev.new()
par(mfrow = c(2,2), cex.main = 3)
acf(ts_y_MIS_W, col = col_mis_w, main = 'West MIS - Yearly - ACF', lwd = 5);
pacf(ts_y_MIS_W, col = col_mis_w, main = 'West MIS - Yearly - pACF', lwd = 5)
acf(ts_y_OTB_W, col = col_otb_w, main = 'West OTB - Yearly - ACF', lwd = 5);
pacf(ts_y_OTB_W, col = col_otb_w, main = 'West OTB - Yearly - pACF', lwd = 5)

grid.echo()
fig = grid.grab()

ggsave(fig, dpi = 300, units = 'cm', filename = 'plots/res_boxjenkins_year_W_acf.png')
```

# ACF - Yearly South

```{r, fig.height = 20, fig.width=20}
dev.new()
par(mfrow = c(2,2), cex.main = 3)
acf(ts_y_MIS_S, col = col_mis_s, main = 'South MIS - Yearly - ACF', lwd = 5);
pacf(ts_y_MIS_S, col = col_mis_s, main = 'South MIS - Yearly - pACF', lwd = 5)
acf(ts_y_OTB_S, col = col_otb_s, main = 'South OTB - Yearly - ACF', lwd = 5);
pacf(ts_y_OTB_S, col = col_otb_s, main = 'South OTB - Yearly - pACF', lwd = 5)

grid.echo()
fig = grid.grab()

ggsave(fig, dpi = 300, units = 'cm', filename = 'plots/res_boxjenkins_year_S_acf.png')
```

# Estacionariedade:

```{r}

estacionaridade = c()
series = c('ts_w_MIS_W','ts_w_OTB_W',
           'ts_w_MIS_S','ts_w_OTB_S',
           'ts_y_MIS_W','ts_y_OTB_W',
           'ts_y_MIS_S','ts_y_OTB_S')

for(i in series){
  temp = get(i)
  res = tseries::adf.test(temp, alternative='s') # pvalue = 0.01
  estacionaridade[length(estacionaridade)+1] = res$p.value
  rm(temp, res)
}

diferenca_ns = c()
diferenca_s = c()

for(i in 1:8){
  temp = get(series[i])
  res_ns = ndiffs(temp)
  diferenca_ns[length(diferenca_ns)+1] = res_ns
  if(i %in% c(1:4)){
    diferenca_s[length(diferenca_s)+1] = nsdiffs(temp)}
    else{diferenca_s[length(diferenca_s)+1] = NA}
  rm(temp, res_ns)
}

tab_estac = data.frame('fleet' = c('Polyvalent Fleet - West Coast - Weeks',
                                 'Bottom Trawl Fleet - West Coast - Weeks',
                                 'Polyvalent Fleet - South Coast - Weeks',
                                 'Bottom Trawl Fleet - South Coast - Weeks',
                                 'Polyvalent Fleet - West Coast - Years',
                                 'Bottom Trawl Fleet - West Coast - Years',
                                 'Polyvalent Fleet - South Coast - Years',
                                 'Bottom Trawl Fleet - South Coast - Years'),
                       'p-value' = estacionaridade,
                       'Estationary?' = ifelse(estacionaridade < 0.05, 'Yes', 'No'),
                       'Differentiation' = diferenca_ns,
                       'S. Differentiation' = diferenca_s)

# BoxCox.lambda(ts_w_MIS_S)
# tseries::kpss.test(ts_w_MIS_S)

xtable(tab_estac) %>% 
  print(.,
        type = "latex",
        file = "tables/res_estac.tex", 
        include.rownames = F,
        only.contents = T)
```




# Modelacao

## Weekly

### ts_w_MIS_S

It does not appear for the polyvalent fleet in the South that differentiation is necessary

```{r}
nsdiffs(ts_w_MIS_S)
ndiffs(diff(ts_w_MIS_S,12))
```

```{r}
dts.train = window(ts_w_MIS_S, end=c(2020,52))
dts.test=window(ts_w_MIS_S, start=c(2021,1), end=c(2022,52))

auto.arima(dts.train) 
# (2,1,2)x(1,0,1)_52
m1 = Arima(dts.train, order = c(2,1,2), seasonal=list(order=c(1,0,1), period=52))
m1.f = forecast(m1,h=104)

```

```{r}

gridExtra::grid.arrange(
  autoplot(m1.f,
         alpha = 1,
         size = 0.5,
         col = wes_palette('FantasticFox1',4)[1],
         fcol = wes_palette('FantasticFox1',4)[2]) +
    labs(title = expression('SARIMA(2,1,2)*(1,0,1)'[52])) +
    theme_light(),
  autoplot(dts.train, col = wes_palette('FantasticFox1',4)[3]) +
  autolayer(dts.test, color = wes_palette('FantasticFox1',4)[4],
          linetype = 'dashed') +
  labs(title = 'Real Data') +
  theme_light(),
ncol=1)
  


autoplot(m1.f,
         alpha = 1,
         size = 0.5) +
  # xlim(as.Date('01-01-2020', format = '%d-%m-%Y'),
  #      as.Date('01-12-2020', format = '%d-%m-%Y')) +
autolayer(dts.test, color = 'red',
          linetype = 'dashed') +
  labs(title = expression('SARIMA(2,1,2)*(1,0,1)'[52])) +
  theme_light()
```


